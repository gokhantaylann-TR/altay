<!DOCTYPE html>
<html lang="tr">
<head><link rel="manifest" href="manifest.json">

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">

<title>Altay'ın Büyük Macerası</title>
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .then((reg) => console.log('Service Worker kayıt edildi:', reg.scope))
        .catch((err) => console.log('Service Worker hatası:', err));
    });
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>

<style>
/* CSS: Tam ekran, seçim engelleme ve iOS kaydırma engelleme */
* {
    box-sizing: border-box;
    -webkit-touch-callout: none; /* iOS'ta uzun basınca çıkan menüyü engelle */
    -webkit-user-select: none; /* Metin seçimini engelle */
    user-select: none;
}

html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  background: #000; /* Çentik kısımları siyah görünsün */
  overflow: hidden;
  touch-action: none; /* Tarayıcı kaydırmasını kapat */
}

canvas {
    display: block;
    margin: 0 auto;
    /* Canvas'ın mobilde düzgün oturması için */
    max-width: 100%;
    max-height: 100%;
}

.ui-controls {
  position: fixed;
  bottom: 20px;
  left: 0;
  right: 0;
  display: flex;
  justify-content: space-between;
  padding: 0 30px;
  pointer-events: none;
  z-index: 100;
  
  /* iPhone X ve üzeri için alt çubuk boşluğu */
  padding-bottom: env(safe-area-inset-bottom, 20px);
}

.ui-controls div {
    pointer-events: auto; /* Sadece butonlara tıklanabilsin */
}

.btn {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  border: 4px solid rgba(255,255,255,0.6);
  font-size: 36px;
  background: rgba(0,0,0,0.4);
  color: #fff;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  margin: 0 10px;
  cursor: pointer;
  /* Mobilde tıklama gecikmesini önler */
  touch-action: manipulation; 
}

/* Dokunulduğunda efekt */
.btn:active, .btn.pressed {
  background: rgba(255, 255, 255, 0.3);
  transform: scale(0.90);
}

.jump-btn {
    background: rgba(255, 140, 0, 0.5);
    width: 90px;
    height: 90px;
}
</style>
</head>

<body>

<div class="ui-controls">
  <div>
    <div id="btnLeft" class="btn">◀</div>
    <div id="btnRight" class="btn">▶</div>
  </div>
  <div>
    <div id="btnJump" class="btn jump-btn">▲</div>
  </div>
</div>

<script>
const config = {
  type: Phaser.AUTO, // Mobilde bazen CANVAS daha performanslı olabilir ama AUTO iyidir
  width: 800,
  height: 600,
  backgroundColor: '#87ceeb',
  scale: {
    mode: Phaser.Scale.FIT, // Ekran oranını koruyarak sığdır
    autoCenter: Phaser.Scale.CENTER_BOTH
  },
  physics: {
    default: 'arcade',
    arcade: { 
        gravity: { y: 900 }, // Yerçekimi biraz artırıldı (daha tok hissiyat)
        debug: false 
    }
  },
  // *** KRİTİK DÜZELTME: Sesi kapatıyoruz (Safari donmasını engeller) ***
  audio: {
      noAudio: true
  },
  // Çoklu dokunma desteği
  input: {
      activePointers: 3 
  },
  scene: { preload, create, update }
};

// --- GLOBAL DEĞİŞKENLER ---
let player;
let platforms;
let cursors;
let enemies;
let diamonds;
let score = 0;
let health = 3;
let timer = 0;
let gameTimeEvent;

// UI Metinleri
let scoreText;
let healthText;
let timeText;
let gameOver = false;
let isInvincible = false;

// Kontrol değişkenleri
let moveLeft = false;
let moveRight = false;
let doJump = false;

// Oyunu başlat
const game = new Phaser.Game(config);

function preload() {
  this.load.image('sky', 'https://labs.phaser.io/assets/skies/space3.png');
  this.load.image('ground', 'https://labs.phaser.io/assets/sprites/platform.png');
  this.load.image('diamond', 'https://labs.phaser.io/assets/sprites/diamond.png');
  this.load.spritesheet('altay', 'https://labs.phaser.io/assets/sprites/dude.png', { frameWidth: 32, frameHeight: 48 });
  this.load.spritesheet('baddie', 'https://labs.phaser.io/assets/sprites/baddie.png', { frameWidth: 32, frameHeight: 32 });
}

function create() {
  score = 0;
  health = 3;
  timer = 0;
  gameOver = false;
  
  // 1. DÜNYA SINIRLARI
  this.physics.world.setBounds(0, 0, 3200, 600);
  
  // Arkaplan
  this.add.tileSprite(1600, 300, 3200, 600, 'sky').setScrollFactor(0.5);

  // 2. PLATFORMLAR & KALE
  platforms = this.physics.add.staticGroup();
  createLevel(platforms);
  createCastle(platforms, 3000, 480);

  // 3. OYUNCU
  player = this.physics.add.sprite(100, 450, 'altay');
  player.setBounce(0.1);
  player.setCollideWorldBounds(true);
  
  this.anims.create({
      key: 'left',
      frames: this.anims.generateFrameNumbers('altay', { start: 0, end: 3 }),
      frameRate: 10, repeat: -1
  });
  this.anims.create({
      key: 'turn',
      frames: [ { key: 'altay', frame: 4 } ],
      frameRate: 20
  });
  this.anims.create({
      key: 'right',
      frames: this.anims.generateFrameNumbers('altay', { start: 5, end: 8 }),
      frameRate: 10, repeat: -1
  });

  this.anims.create({
      key: 'duckWalk',
      frames: this.anims.generateFrameNumbers('baddie', { start: 0, end: 3 }),
      frameRate: 10, repeat: -1
  });

  // 4. ELMASLAR
  diamonds = this.physics.add.group({
      key: 'diamond',
      repeat: 20,
      setXY: { x: 300, y: 0, stepX: 130 }
  });

  diamonds.children.iterate(function (child) {
      if(child) {
        child.setBounceY(Phaser.Math.FloatBetween(0.4, 0.8));
        child.y = Phaser.Math.Between(100, 400); 
      }
  });

  // 5. DÜŞMANLAR
  enemies = this.physics.add.group();
  createEnemy(enemies, 600, 400);
  createEnemy(enemies, 1200, 300);
  createEnemy(enemies, 1800, 450);
  createEnemy(enemies, 2400, 250);
  createEnemy(enemies, 2700, 450);

  // 6. KAMERA
  this.cameras.main.setBounds(0, 0, 3200, 600);
  this.cameras.main.startFollow(player, true, 0.08, 0.08);

  // 7. UI
  createUI(this);

  // 8. FİZİK
  this.physics.add.collider(player, platforms);
  this.physics.add.collider(diamonds, platforms);
  this.physics.add.collider(enemies, platforms);
  
  this.physics.add.overlap(player, diamonds, collectDiamond, null, this);
  this.physics.add.overlap(player, enemies, hitEnemy, null, this);
  
  const winZone = this.add.zone(3080, 500, 50, 100);
  this.physics.add.existing(winZone);
  this.physics.add.overlap(player, winZone, winLevel, null, this);

  // 9. KONTROLLER
  cursors = this.input.keyboard.createCursorKeys();
  setupTouchControls(); // Geliştirilmiş versiyon çağırılıyor

  if (gameTimeEvent) gameTimeEvent.remove();
  gameTimeEvent = this.time.addEvent({ delay: 1000, callback: onSecondPassed, callbackScope: this, loop: true });
}

// --- SEVİYE TASARIMI ---
function createLevel(platforms) {
    createLongPlatform(platforms, 0, 580, 4); 
    createLongPlatform(platforms, 1000, 580, 5);
    createLongPlatform(platforms, 2100, 580, 10);

    platforms.create(400, 400, 'ground');
    platforms.create(700, 300, 'ground');
    platforms.create(900, 450, 'ground').setScale(0.5, 1).refreshBody();
    platforms.create(1300, 250, 'ground'); 
    platforms.create(1500, 400, 'ground');
    platforms.create(1900, 350, 'ground');
    platforms.create(2300, 280, 'ground'); 
    platforms.create(2600, 400, 'ground').setScale(0.5,1).refreshBody();
    platforms.create(2750, 300, 'ground').setScale(0.5,1).refreshBody();
}

function createLongPlatform(group, startX, y, count) {
    for(let i=0; i<count; i++) {
        group.create(startX + (i * 400), y, 'ground').setScale(2).refreshBody();
    }
}

function createCastle(platforms, x, y) {
    platforms.create(x, y - 50, 'ground').setScale(0.2, 5).refreshBody().setTint(0x888888);
    platforms.create(x + 160, y - 50, 'ground').setScale(0.2, 5).refreshBody().setTint(0x888888);
    platforms.create(x + 80, y - 180, 'ground').setScale(1, 0.5).refreshBody().setTint(0x666666);
    platforms.create(x + 80, y + 20, 'ground').setScale(0.8, 0.5).refreshBody().setTint(0x888888);
    platforms.create(x + 80, y - 230, 'ground').setScale(0.05, 2).refreshBody().setTint(0x000000);
}

function createEnemy(group, x, y) {
    const enemy = group.create(x, y, 'baddie');
    enemy.setTint(0xffff00); 
    enemy.setBounce(0.5);
    enemy.setCollideWorldBounds(true);
    enemy.setVelocityX(100);
    enemy.anims.play('duckWalk', true);
    enemy.direction = 1; 
}

function createUI(scene) {
    const style = { font: '20px Arial', fill: '#ffffff', stroke: '#000000', strokeThickness: 4 };
    
    healthText = scene.add.text(20, 20, 'Can: ❤️❤️❤️', style).setScrollFactor(0);
    scoreText = scene.add.text(20, 50, 'Puan: 0', style).setScrollFactor(0);
    timeText = scene.add.text(780, 20, 'Süre: 0s', style).setScrollFactor(0).setOrigin(1, 0); 
}

function update() {
    if (gameOver) return;

    // --- OYUNCU HAREKETİ ---
    // Klavye VEYA Dokunmatik kontrol
    if (cursors.left.isDown || moveLeft) {
        player.setVelocityX(-220);
        player.anims.play('left', true);
    } else if (cursors.right.isDown || moveRight) {
        player.setVelocityX(220);
        player.anims.play('right', true);
    } else {
        player.setVelocityX(0);
        player.anims.play('turn');
    }

    if ((cursors.up.isDown || doJump) && player.body.touching.down) {
        player.setVelocityY(-600);
        doJump = false; // Otomatik zıplamayı kesmek için
    }

    // --- DÜŞMAN AI ---
    enemies.children.iterate(function (child) {
        // Ölen düşmanlar listeden silindiği için null kontrolü ve active kontrolü şart
        if(!child || !child.active) return;

        if (child.body.blocked.right) {
            child.setVelocityX(-100);
            child.direction = -1;
            child.flipX = false;
        } else if (child.body.blocked.left) {
            child.setVelocityX(100);
            child.direction = 1;
            child.flipX = true;
        }

        if (child.body.touching.down && Math.random() < 0.01) {
            child.setVelocityY(-400);
        }
    });

    if (player.y > 600) {
        takeDamage(this);
        player.setPosition(100, 450);
        player.setVelocity(0,0);
    }
}

function collectDiamond(player, diamond) {
    diamond.disableBody(true, true);
    score += 10;
    scoreText.setText('Puan: ' + score);
}

function hitEnemy(player, enemy) {
    if (isInvincible || gameOver) return;

    if (player.body.velocity.y > 0 && player.y < enemy.y) {
        enemy.destroy(); // Düşman yok edildiğinde aktiflikten çıkar
        player.setVelocityY(-350); 
        score += 20;
        scoreText.setText('Puan: ' + score);
    } else {
        takeDamage(this);
    }
}

function takeDamage(scene) {
    if (isInvincible) return;

    health--;
    updateHealthUI();
    
    player.setVelocityY(-250);
    player.setTint(0xff0000);
    
    if (health <= 0) {
        finishGame(scene, false);
    } else {
        isInvincible = true;
        scene.time.delayedCall(1000, () => {
            isInvincible = false;
            player.clearTint();
        });
    }
}

function updateHealthUI() {
    let hearts = '';
    for(let i=0; i<health; i++) hearts += '❤️';
    healthText.setText('Can: ' + hearts);
}

function onSecondPassed() {
    if (gameOver) return;
    timer++;
    timeText.setText('Süre: ' + timer + 's');
}

function winLevel(player, zone) {
    finishGame(this, true);
}

function finishGame(scene, isWin) {
    scene.physics.pause();
    gameOver = true;
    
    let msg = isWin ? 'TEBRİKLER!\nKALE FETHEDİLDİ!' : 'OYUN BİTTİ!';
    let color = isWin ? '#00ff00' : '#ff0000';
    
    // UI'ın ortasına gelsin
    let centerX = scene.cameras.main.width / 2;
    let centerY = scene.cameras.main.height / 2;

    let txt = scene.add.text(centerX, centerY, msg, {
        fontSize: '40px',
        fill: color,
        align: 'center',
        backgroundColor: '#000',
        padding: { x: 20, y: 20 }
    }).setOrigin(0.5).setScrollFactor(0); // Ekrana sabitle
    
    scene.add.text(centerX, centerY + 80, 'Puan: ' + score + ' | Süre: ' + timer + 's', {
        fontSize: '24px', fill: '#fff'
    }).setOrigin(0.5).setScrollFactor(0);

    scene.add.text(centerX, centerY + 130, 'Tekrar Oynamak İçin Dokun', {
        fontSize: '18px', fill: '#aaa'
    }).setOrigin(0.5).setScrollFactor(0);

    scene.input.once('pointerdown', () => {
        scene.scene.restart();
    });
}

// --- GÜÇLENDİRİLMİŞ DOKUNMATİK KONTROLLER ---
function setupTouchControls() {
    const bindBtn = (id, startAction, endAction) => {
        const el = document.getElementById(id);
        
        // Passive: false, Safari'nin varsayılan davranışını (scroll) engellemek için zorunludur
        el.addEventListener('touchstart', (e) => { 
            e.preventDefault(); 
            el.classList.add('pressed');
            startAction(); 
        }, { passive: false });

        el.addEventListener('touchend', (e) => { 
            e.preventDefault(); 
            el.classList.remove('pressed');
            endAction(); 
        });

        // Bilgisayarda test etmek için mouse olayları
        el.addEventListener('mousedown', () => { startAction(); el.classList.add('pressed'); });
        el.addEventListener('mouseup', () => { endAction(); el.classList.remove('pressed'); });
        el.addEventListener('mouseleave', () => { endAction(); el.classList.remove('pressed'); });
    };

    bindBtn('btnLeft', () => moveLeft = true, () => moveLeft = false);
    bindBtn('btnRight', () => moveRight = true, () => moveRight = false);
    bindBtn('btnJump', () => doJump = true, () => doJump = false);
}
</script>
</body>
</html>
